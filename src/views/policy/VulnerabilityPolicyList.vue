<template>
  <div class="animated fadeIn" v-permission="'POLICY_MANAGEMENT'">
    <b-alert v-if="bundleSyncStatus === 'FAILED'" variant="danger" dismissible show>
      <strong>{{ $t('message.policy_last_bundle_sync_failed') }}</strong>: {{this.bundleSyncWorkflowState.failureReason}}
    </b-alert>
    <div id="vulnerabilityPolicyToolbar" class="bs-table-custom-toolbar">
      <b-button variant="outline-primary" v-b-modal.policyBundleInfoModal :disabled="!bundleInfo">
        <span class="fa fa-archive"/>
        {{ $t('message.policy_bundle_info') }}
      </b-button>
      <b-button v-permission:or="[PERMISSIONS.POLICY_MANAGEMENT]" variant="outline-primary" @click="sync" :disabled="bundleSyncStatus === 'PENDING'">
        <b-spinner v-if="bundleSyncStatus === 'PENDING'" small />
        <span v-if="bundleSyncStatus !== 'PENDING'" class="fa fa-refresh"/>
        {{ $t('message.policy_bundle_sync') }}
      </b-button>
    </div>
    <bootstrap-table
      ref="table"
      :columns="columns"
      :data="data"
      :options="options"
      @on-load-success="tableLoaded">
    </bootstrap-table>
    <policy-bundle-info-modal :bundleInfo="cloneDeep(bundleInfo)" />
  </div>
</template>

<script>
  import xssFilters from "xss-filters";
  import i18n from "../../i18n";
  import common from "../../shared/common";
  import MonacoEditor from "@/views/components/MonacoEditor.vue";
  import permissionsMixin from "../../mixins/permissionsMixin";
  import $ from "jquery";
  import BootstrapToggle from "vue-bootstrap-toggle";
  import bootstrapTableMixin from "../../mixins/bootstrapTableMixin";
  import BInputGroupFormInput from "../../forms/BInputGroupFormInput";
  import PolicyBundleInfoModal from "./PolicyBundleInfoModal";
  import { cloneDeep } from 'lodash-es';
  import {loadUserPreferencesForBootstrapTable} from "@/shared/utils";

  export default {
    mixins: [permissionsMixin, bootstrapTableMixin],
    components: {
      PolicyBundleInfoModal
    },
    methods: {
      cloneDeep: function(component) {
        return cloneDeep(component);
      },
      apiUrl: function () {
        return `${this.$api.BASE_URL}/${this.$api.URL_VULNERABILITY_POLICY}`;
      },
      tableLoaded: function(data) {
        if (data && Object.prototype.hasOwnProperty.call(data, "total")) {
          this.$emit('total', data.total);
        } else {
          this.$emit('total', '?');
        }
      },
      refreshTable: function() {
        this.$refs.table.refresh({
          url: this.apiUrl(),
          silent: true
        });
      },
      initializeTooltips: function () {
        $('[data-toggle="tooltip"]').tooltip();
      },
      onLoadSuccess: function () {
        loadUserPreferencesForBootstrapTable(this, "VulnerabilityPolicyList", this.$refs.table.columns);
      },
      sync: function () {
        let syncUrl = `${this.$api.BASE_URL}/${this.$api.URL_VULNERABILITY_POLICY}/bundle/sync`
        this.axios
          .post(syncUrl)
          .then(() => {
            this.$toastr.s(this.$t('message.policy_bundle_sync_requested'));
            return this.fetchBundleSyncStatus();
          })
          .catch(error => {
            this.$toastr.w(error.response.data.message);
          });
      },
      fetchBundleSyncStatus() {
        this.axios
          .get(`${this.$api.BASE_URL}/${this.$api.URL_WORKFLOW}/token/${this.bundleSyncToken}/status`)
          .then(response => {
            if (!response.data || !Array.isArray(response.data)) {
              return;
            }

            let workflowState = response.data[0];
            if (workflowState.step !== "POLICY_BUNDLE_SYNC") {
              console.log(`Unexpected workflow step: ${JSON.stringify(workflowState)}`);
              return;
            }

            this.bundleSyncWorkflowState = workflowState;
            this.bundleSyncStatus = workflowState.status;
            if (this.bundleSyncStatus === "PENDING" && !this.bundleSyncStatusPollInterval) {
              this.bundleSyncStatusPollInterval = setInterval(this.fetchBundleSyncStatus, 1000);
            } else if (this.bundleSyncStatus !== "PENDING") {
              clearInterval(this.bundleSyncStatusPollInterval);
              this.bundleSyncStatusPollInterval = null;
            }

            return workflowState;
          })
          .catch((error) => {
            if (error.response && error.response.status === 404) {
              return Promise.resolve();
            }
          })
          .then((workflowState) => {
            this.getBundleInfo();
            if (workflowState.status === "COMPLETED") {
              this.refreshTable();
            }

            return workflowState;
          })
      },
      getBundleInfo: function() {
        let url = `${this.$api.BASE_URL}/${this.$api.URL_VULNERABILITY_POLICY}/bundle`;
        this.axios
          .get(url)
          .then(response => {
            this.bundleInfo = response.data;
          })
          .catch(() => {
            this.$toastr.w(this.$t("condition.unsuccessful_action"));
          });
      },
    },
    mounted: function() {
      this.fetchBundleSyncStatus();
    },
    data() {
      return {
        bundleSyncToken: "bc106cf4-3993-4e38-952d-d2f5f11412ed",
        bundleSyncStatus: null,
        bundleSyncWorkflowState: null,
        bundleSyncStatusPollInterval: null,
        bundleInfo: {},
        columns: [
          {
            title: this.$t('message.name'),
            field: "name",
            sortable: true,
            formatter(value, row, index) {
              return xssFilters.inHTMLData(common.valueWithDefault(value, ""));
            }
          },
          {
            title: this.$t('message.author'),
            field: "author",
            sortable: true,
            formatter(value, row, index) {
              return xssFilters.inHTMLData(common.valueWithDefault(value, "-"));
            }
          },
          {
            title: this.$t('message.validFrom'),
            field: "validFrom",
            sortable: true,
            formatter(value, row, index) {
              return (typeof value !== 'undefined' && value != null) ? common.formatTimestamp(Math.trunc(value * 1000)) : "-";
            }
          },
          {
            title: this.$t('message.validUntil'),
            field: "validUntil",
            sortable: true,
            formatter(value, row, index) {
              return (typeof value !== 'undefined' && value != null) ? common.formatTimestamp(Math.trunc(value * 1000)) : "-";
            }
          },
          {
            title: this.$t('message.created'),
            field: "created",
            sortable: true,
            formatter(value, row, index) {
              return (typeof value !== 'undefined' && value != null) ? common.formatTimestamp(Math.trunc(value * 1000)) : "-";
            }
          },
          {
            title: this.$t('message.updated'),
            field: "updated",
            sortable: true,
            formatter(value, row, index) {
              return (typeof value !== 'undefined' && value != null) ? common.formatTimestamp(Math.trunc(value * 1000)) : "-";
            }
          }
        ],
        data: [],
        options: {
          onPostBody: this.initializeTooltips,
          search: true,
          showColumns: true,
          showRefresh: true,
          pagination: true,
          silentSort: false,
          sidePagination: 'server',
          queryParamsType: 'pageSize',
          pageList: '[10, 25, 50, 100]',
          pageSize: (localStorage && localStorage.getItem("VulnerabilityPolicyListPageSize") !== null) ? Number(localStorage.getItem("VulnerabilityPolicyListPageSize")) : 10,
          sortName: (localStorage && localStorage.getItem("VulnerabilityPolicyListSortName") !== null) ? localStorage.getItem("VulnerabilityPolicyListSortName") : undefined,
          sortOrder: (localStorage && localStorage.getItem("VulnerabilityPolicyListSortOrder") !== null) ? localStorage.getItem("VulnerabilityPolicyListSortOrder") : undefined,
          icons: {
            refresh: 'fa-refresh'
          },
          detailView: true,
          detailViewIcon: false,
          detailViewByClick: true,
          detailFormatter: (index, row) => {
            return this.vueFormatter({
              i18n,
              template: `
                <b-row class="expanded-row">
                  <b-col sm="6">
                    <b-form-group id="fieldset-1" :label="this.$t('message.conditions')" label-for="imput-1" disabled>
                      <b-form-group v-for="condition in conditions">
                        <MonacoEditor :readOnly="true" id="input-value" v-model="condition" :debounce-events="'keyup'"/>
                      </b-form-group>
                    </b-form-group>

                      <b-form-group id="fieldset-2" :label="this.$t('message.ratings')" label-for="input-2">
                        <b-card>
                          <b-input-group-form-input :label="this.$t('message.method')" input-group-size="mb-3"
                          required="false" v-model="this.rating_method" lazy="true" autofocus="true" disabled="true"/>
                          <b-input-group-form-input :label="this.$t('message.severity')" input-group-size="mb-3"
                          required="false" v-model="this.rating_severity" lazy="true" autofocus="true" disabled="true"/>
                          <b-input-group-form-input :label="this.$t('message.score')" input-group-size="mb-3"
                          required="false" v-model="this.rating_score" lazy="true" autofocus="true" disabled="true"/>
                          <b-input-group-form-input :label="this.$t('message.vector')" input-group-size="mb-3"
                          required="false" v-model="this.rating_vector" lazy="true" autofocus="true" disabled="true"/>
                        </b-card>
                      </b-form-group>

                  </b-col>
                  <b-col sm="6">
                    <b-form-group id="fieldset-1" :label="this.$t('message.description')" label-for="input-1">
                      <b-form-textarea rows="4" id="input-1" v-model="this.policy.description" disabled class="form-control disabled" trim />
                    </b-form-group>

                      <b-row>
                        <b-col sm="6">
                          <b-form-group id="fieldset-2" :label="this.$t('message.analysis')" label-for="input-2" />
                        </b-col>
                        <b-col sm="6" align="right">
                          <span v-if="this.analysis.suppress"><i class="fa fa-check-square-o" /></span>
                          <span v-else><i class="fa fa-square-o" /></span>
                            Suppressed
                        </b-col>
                      </b-row>
                      <b-card>
                      <b-form-group
                          <b-input-group-form-input :label="this.$t('message.state')" input-group-size="mb-3"
                          required="false" v-model="this.analysis.state" lazy="true" autofocus="true" disabled="true"/>
                          <b-input-group-form-input :label="this.$t('message.justification')" input-group-size="mb-3"
                          required="false" v-model="this.analysis.justification" lazy="true" autofocus="true" disabled="true"/>
                          <b-input-group-form-input :label="this.$t('message.vendor_response')" input-group-size="mb-3"
                          required="false" v-model="this.analysis.vendorResponse" lazy="true" autofocus="true" disabled="true"/>
                          <b-input-group-form-input :label="this.$t('message.details')" input-group-size="mb-3"
                          required="false" v-model="this.analysis.details" lazy="true" autofocus="true" disabled="true"/>
                      </b-form-group>
                    </b-card>
                  </b-col>
                </b-row>
              `,
              data() {
                return {
                  policy: row,
                  conditions: row.conditions,
                  rating_method: row.ratings && row.ratings[0] != null ? row.ratings[0].method : null,
                  rating_severity: row.ratings && row.ratings[0] != null ? row.ratings[0].severity : null,
                  rating_score: row.ratings && row.ratings[0] != null ? row.ratings[0].score : null,
                  rating_vector: row.ratings && row.ratings[0] != null ? row.ratings[0].vector : null,
                  analysis: row.analysis,
                }
              },
              components: {
                BootstrapToggle,
                BInputGroupFormInput,
                MonacoEditor,
              }
            })
          },
          onExpandRow: this.vueFormatterInit,
          toolbar: '#vulnerabilityPolicyToolbar',
          responseHandler: function (res, xhr) {
            res.total = xhr.getResponseHeader("X-Total-Count");
            return res;
          },
          url: this.apiUrl(),
          onPageChange: ((number, size) => {
            if (localStorage) {
              localStorage.setItem("VulnerabilityPolicyListPageSize", size.toString())
            }
          }),
          onColumnSwitch: ((field, checked) => {
            if (localStorage) {
              localStorage.setItem("VulnerabilityPolicyListShow"+common.capitalize(field), checked.toString())
            }
          }),
          onSort: ((name, order) => {
            if (localStorage) {
              localStorage.setItem("VulnerabilityPolicyListSortName", name);
              localStorage.setItem("VulnerabilityPolicyListSortOrder", order);
            }
          })
        }
      };
    }
  };
</script>
